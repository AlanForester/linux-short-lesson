##Инициализация системы. Systemd, init-v

####Управление сервисами, автозапуск сервисов, старт-стоп сервисов, написание скриптов запуска, runlevels, зависимости.

systemctl является основной командой для управления сервисами в systemd. 
Изначально разработана только для Linux, и опирается на специфичные для него функции, по этой причине Debian, как дистрибутив, 
работающий на различных ядрах (не только Linux), не полностью реализует systemd. Для каждой службы, systemd
использует свой файл юнита.

systemd поддерживает следующие типы юнит файлов:
- .target — позволяет группировать юниты, воплощая концепцию уровней запуска(см. ниже)
- .service — отвечает за запуск сервисов, также поддерживает вызов интерпретаторов для исполнения пользовательских скриптов
- .mount — отвечает за монтирование файловых систем
- .automount — позволяет отложить монтирование файловых систем до фактического обращения к точке монтирования
- .swap — отвечает за подключение файла подкачки
- .timer — позволяет запускать юниты по расписанию
- .socket — предоставляет сервисам поддержку сокетов
- .slice — отвечает за создание контейнера cgroups(Только RPM дистрибутивы)
- .device — позволяет реагировать на подключение устройств
- .path — управляет иерархией файловой системы.

Помимо простого запуска и контроля служб, предлагает некоторые другие удобные функции, 
для использования которых ранее системным администраторам приходилось прибегать к помощи дополнительных программ.

Главная команда для мониторинга и управления systemd — systemctl. Примеры использования с описанием,
вы можете увидеть в файле systemctl.sh . В качестве примера в файле используется служба nginx

### Файлы юнитов
Файлы юнитов находятся в каталогах /usr/lib/systemd/system/ и /etc/systemd/system/ который запускается в приоритете.

Ниже приведен пример юнита nginx.service:
```shell script
[Unit]
Description=Nginx
After=network.target
[Service]
ExecStart=/usr/sbin/nginx
[Install]
WantedBy=multi-user.target
```

Некоторые юниты содержат в названии символ @. Например экземпляр с именем first nginx@first.service) принадлежит
nginx сервису настоящее имя которого не содержит части имени экземпляра. В нашем случае nginx@.service

**Основные опции** [Unit]
```
Description     - Краткое описание юнита.
Documentation   - Список ссылок на документацию.
Before, After	- Порядок запуска юнитов.
Requires        - Если этот сервис активируется, перечисленные здесь юниты тоже будут активированы. Если один из перечисленных юнитов останавливается или падает, этот сервис тоже будет остановлен.
Wants	        - Как и Requires, но если один из перечисленных юнитов не может успешно запуститься, это не повлияет на запуск данного сервиса. Это рекомендуемый способ установления зависимостей.
Conflicts       - Если установлено что данный сервис конфликтует с другим юнитом, то запуск последнего остановит этот сервис и наоборот.
```

**Основные опции** [Install]
```
Alias       - Дополнительные имена сервиса разделенные пробелами. Большинство команд в systemctl, за исключением systemctl enable, могут использовать альтернативные имена сервисов.
RequiredBy  - Данный сервис будет запущен при запуске зависимых сервисов. 
WantedBy    - Данный сервис будет запущен при запуске зависимых сервисов, но не будет остановлен при невозможности запуска зависимостей.
Also	    - Определяет список юнитов, которые также будут активированы или дезактивированы вместе с данным сервисом при выполнении команд systemctl enable или systemctl disable.
```

**Важные Опции Секции** [Service]
```
Type            - Настраивает тип запуска процесса. Один из:
simple          — запускает сервис мгновенно. Предполагается, что основной процесс сервиса задан в ExecStart.
forking         — считает сервис запущенным после того, как родительский процесс создает процесс-потомка, а сам завершится.
oneshot         — аналогичен типу simple, но предполагается, что процесс должен завершиться до того, как systemd начнет отслеживать состояния юнитов (удобно для скриптов, которые выполняют разовую работу и завершаются). Возможно вы также захотите использовать RemainAfterExit=yes, чтобы systemd продолжал считать сервис активным и после завершения процесса.
dbus            — аналогичен типу simple, но считает сервис запущенным после того, как основной процесс получает имя на шине D-Bus.
notify          — аналогичен типу simple, но считает сервис запущенным после того, как он отправляет systemd специальный сигнал.
idle            - аналогичен типу simple, но фактический запуск исполняемого файла сервиса откладывается, пока не будут выполнены все задачи.
ExecStart       - Команды вместе с аргументами, которые будут выполнены при старте сервиса. Опция Type=oneshot позволяет указывать несколько команд, которые будут выполняться последовательно. Опции ExecStartPre и ExecStartPost могут задавать дополнительные команды, которые будут выполнены до или после ExecStart.
ExecStop        - Команды, которые будут выполнены для остановки сервиса запущенного с помощью ExecStart.
ExecReload      - Команды, которые будут выполнены чтобы сообщить сервису о необходимости перечитать конфигурационные файлы.
Restart	        - Если эта опция активирована, сервис будет перезапущен если процесс прекращен или достигнут timeout, за исключением случая нормальной остановки сервиса с помощью команды systemctl stop
RemainAfterExit - Если установлена в значение True, сервис будет считаться запущенным даже если сам процесс завершен. Полезен с Type=oneshot. Значение по умолчанию False.
```
Подробнее о структуре юнитов смотрите [systemd.unit(5)](https://jlk.fjfi.cvut.cz/arch/manpages/man/systemd.unit.5)

#### Зависимости юнитов
Пример: юниту Nginx требуется, чтобы юнит MySQL был запущен перед запуском самого юнита Nginx. 
В этом случае добавьте строки Requires=MySQL и After=MySQL в раздел [Unit] юнит-файла Nginx.
Обычно зависимости указываются в файлах сервисов(.service), а не в целевых (.target) юнитах.
Например, network.target потребуется любой службе, которая связана с настройкой сетевых интерфейсов, 
поэтому в случае, если ваш сервис использует сеть, определите загрузку вашего юнита после запуска network.target.

#### Типы запуска
Есть несколько типов запуска служб, которые нужно иметь в виду при написании файла службы. 
Тип определяется параметром Type= в разделе [Service]:
```
Type=simple    - по умолчанию, systemd запустит эту службу незамедлительно. Не используйте этот тип, если другие службы зависят от этой в плане очередности запуска. 
Type=forking   - systemd считает службу запущенной после того, как завершается основной процесс. Вам следует также указать PIDFile=, чтобы systemd мог отслеживать основной процесс.
Type=oneshot   - удобен для скриптов, которые выполняют одно задание и завершаются. При необходимости можно задать параметр RemainAfterExit=yes, чтобы systemd считал процесс активным даже после его завершения.
Type=notify    - идентичен параметру Type=simple, но сервис пошлет systemd сигнал о своей готовности. 
Type=dbus      - служба считается находящейся в состоянии готовности, когда указанный параметр BusName появляется в системной шине DBus.
Type=idle      - systemd отложит выполнение исполняемого файла службы до момента выполнения всех остальных задач.
```

Подробнее о параметре Type смотрите [systemd.service(5) #OPTIONS](https://jlk.fjfi.cvut.cz/arch/manpages/man/systemd.service.5#OPTIONS).

### Уровни запуска и цели
Systemd использует юнит типа цель (target) для группировки юнитов по зависимостям. 
Они выполняют ту же задачу, что и уровни запуска OS, но действуют немного по-другому. 
Каждая цель имеет имя, а не номер, и предназначена для конкретных задач. Несколько целей могут быть 
активны одновременно. Некоторые цели реализованы путём наследования служб из других целей с добавлением собственных. 

systemd выбирает default.target в следующем порядке :

Параметр ядра, описанный выше.
Символическая ссылка /etc/systemd/system/default.target.
Символическая ссылка /usr/lib/systemd/system/default.target.

Соответствие уровней SysV целям файлов target в systemd
```
0               runlevel0, poweroff     - Выключение системы
1, s, single    runlevel1, rescue       - Однопользовательский уровень запуска
2, 4            runlevel2(4),multi-user	- Уровни запуска, определенные пользователем. По умолчанию соответствует уровню запуска 3
3               runlevel3, multi-user   - Многопользовательский режим без графики. Пользователи, которые, входят в систему при помощи консоли или через сеть
5               runlevel5, graphical    - Многопользовательский режим с графикой. Обычно эквивалентен запуску всех служб на уровне 3 и графического менеджера входа в систему
6               runlevel6, reboot       - Перезагрузка
emergency       emergency               - Аварийная оболочка
```

Изучите файлы сервисов с именами *.service на конце в текущей директории

[Go back](https://github.com/AlexCollin/linux-short-lesson)